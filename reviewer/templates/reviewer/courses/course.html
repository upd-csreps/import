
{% extends 'reviewer/base.html' %}


{% block title %}
	{{ course_filt.name }}
{% endblock %}

{% load static %}
{% block content %}
	<div class="container pt-5">
		<div class="my-5">
			<div class="m-auto d-flex flex-column align-items-start">
				<div class="w-100">
					<div class="mx-3">
						<div class="d-flex justify-content-between flex-column flex-lg-row mb-3 mb-lg-0">
							<div class="mx-auto mx-lg-0 text-center text-lg-left">
								<h1 class="h1 title" ><strong>{{ course_filt.code }} <span class="import-font-primary">{{ course_filt.number }}</span></strong></h1>
								<h4 class=" h4 mt-2">{{ course_filt.title }}</h4>
							</div>
							<div class="mx-auto mx-lg-0  text-center text-lg-right">
								<div>
									<small class="d-flex">
										<i class="material-icons material-icon-sm mx-2">update</i> Last Updated: {{ course_filt.lastupdated }}
									</small>
									{% if course_filt.old_curr == True %}
										<small class="d-inline-flex mt-1">
											<i class="material-icons material-icon-sm mx-2">error_outline</i>
											This is part of the old curriculum.
										</small>
									{% endif %}
								</div>
							</div>
						</div>
						<div class="mt-1 row">
							<div class="d-flex flex-column col-lg-9 ml-lg-0 ml-auto mr-auto">

								<p class="text-center text-lg-left">{{course_filt.description}}</p>
								<small>
									<div class="mb-1">
										<span>Prerequisites:</span>
										<div class="d-inline-flex align-items-start">
											{% if course_filt.prereqs.count > 0 %}
												{% for prereq in course_filt.prereqs.all %}
													{% if forloop.counter != 1 %}<span class="mr-1">,</span>{%endif%}
													<a href="{% url 'course' prereq.code|lower prereq.number %}">
														{{ prereq.name }}
													</a>
												{% endfor %}
											{% else %}
												None
											{% endif %}
										</div>
									</div>
									<div>
										<span>Corequisites:</span>
										<div class="d-inline-flex align-items-start">
											{% if course_filt.coreqs.count > 0 %}
												{% for coreq in course_filt.coreqs.all %}
													{% if forloop.counter != 1 %}<span class="mr-1">,</span>{%endif%}
													<a href="{% url 'course' coreq.code|lower coreq.number %}">
														{{ coreq.name }}
													</a>
												{% endfor %}
											{% else %}
												None
											{% endif %}
										</div>
									</div>
								</small>
							</div>

							{% if  user.is_superuser %}
								<div class="ml-auto mt-lg-auto mt-0 mb-auto mb-lg-0 col-lg-3 d-flex">
									<a class="ml-auto" href="{% url 'admin_course_id' 'edit' course_filt.code|lower course_filt.number %}">
										<button  type="button" class="btn btn-light px-3 d-flex">
											<div class="my-auto d-flex">
												<i class="material-icons">
													edit
												</i>
												<span class="my-auto ml-1 d-none d-md-block">
												Edit Course</span>	
											</div>
										</button>
									</a>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="">
			<ul class="nav nav-tabs" id="coursetab" role="tablist">
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'l' %}active{%endif%}" id="lessons-tab" data-toggle="tab" href="#lessons" role="tab" aria-controls="lessons" aria-selected="true">Lessons</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'c' %}active{%endif%}" id="comments-tab" data-toggle="tab" href="#comments" role="tab" aria-controls="profile" aria-selected="false">Comments</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'r' %}active{%endif%}" id="ref-tab" data-toggle="tab" href="#ref" role="tab" aria-controls="ref" aria-selected="false">References</a>
			  </li>
			</ul>
			<div class="tab-content" id="import-tabcontents">
			  <div class="tab-pane fade {% if section == 'l' %} show active{%endif%}" id="lessons" role="tabpanel" aria-labelledby="lessons-tab">
			  	...
			  </div>
			  <div class="tab-pane fade {% if section == 'c' %} show active{%endif%}" id="comments" role="tabpanel" aria-labelledby="comments-tab">
			  		{% include 'reviewer/partials/course/course-comments.html' %}
			  </div>
			  <div class="tab-pane fade {% if section == 'r' %} show active{%endif%}" id="ref" role="tabpanel" aria-labelledby="ref-tab">
			  	...
			  </div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}
	<script class="d-none">
		var coursect =  {{course_comment_count}};

		var timeoptions = {
	    	year: 'numeric',
	    	month: 'short',
	    	day: 'numeric',
	    	timeZone: "Asia/Manila",
	    	hour12: true,
	    	hour: "2-digit", 
	    	minute: "2-digit"  
    	};



		// Form AJAX

		function addCommentDisplay(response, datestring, bodystring){
		
			var newcomment = 
			`<div class="py-4 px-4 d-flex mb-3 comment the-new-comment" id="comment-`+ response.commentid + `" style="display:none;">
				 <img class="user-pic-thumb" src="
				{%if user.prof_pic %}
					{{ user.prof_pic.url }}
				{% else %}
					{% static 'reviewer/images/default_profile.png' %}
				{% endif %}

				">
				<div class="ml-4 w-100">
					<div class="d-flex w-100 justify-content-between my-2">
						<span class="my-auto">
							<strong>{{ user.username }}</strong> 
						</span>
						<p class="my-auto">
							<small class="d-inline-flex">
								<span class="mr-3 my-auto">
									<i class="material-icons material-icon-sm {% if user.is_authenticated %}comment-like{%endif%}">
											star_border
										</i> 
										<span class="my-auto ml-1 mr-2 comment-like-count">0</span>
									<i class="material-icons  material-icon-sm comment-delete">delete</i>
								</span>` +
								datestring
							+ `</small>
						</p>
					</div>
					<p>` + replace_url(bodystring) + `</p>` + hasImage(response, "comment") +`
					
				</div>
			</div>`;

			if (coursect != 0){				
				newcomment = newcomment + $(".course-comments").html();
			}
			
			$(".course-comments").html(newcomment);
			$(".the-new-comment").fadeIn(2000);
			$(".the-new-comment").removeClass("the-new-comment");

			coursect = coursect+1;

			let countvalml = coursect + " comment";
			if (coursect != 1){
				countvalml = countvalml+"s";
			}

			$(".comme-count").html(countvalml);			
			
		}


		{% if cpage == 1 %}
			$(".comment-form").submit(function(event){

		    // Prevent default posting of form - put here to work in case of errors
		    event.preventDefault();

		    	{% if user.is_authenticated %}

				    // Abort any pending request
				    if (request) {
				        request.abort();
				    }
				    // setup some local variables
				    var form = $(this);
				    var formData = new FormData(this);
				   
				    // Let's disable the inputs for the duration of the Ajax request.
				    // Note: we disable elements AFTER the form data has been serialized.
				    // Disabled form elements will not be serialized.
				    var inputs = form.find("input, select, button, textarea");
				    inputs.prop("disabled", true);

				    // Fire off the request to url
				    request =  $.ajax({
	                type: 'post',
	                url: "{% url 'course' course_filt.code|lower course_filt.number %}",
	                data: formData,
	                cache: false,
	                contentType: false,
	                processData: false,	
	                });

				    
				     
				    // Callback handler that will be called on success
				    request.done(function (response, textStatus, jqXHR){
				    
				    	response = JSON.parse(response);
				        var today = new Date().toLocaleString('en-us' , timeoptions);
				    	var commtent = $(".comment-text-area").val();
				    	commtent =commtent.split("\n");

				    	for (i = 0; i < commtent.length; i++){
				    		commtent[i] = "<p>" + commtent[i] + "</p>";
				    	}

				    	commtent = commtent.join("");

				    	addCommentDisplay(response, today, commtent);
				    	$(".comment-text-area").val("");
				    	clearImage("comment-image-upload", document.querySelector(".import-image-drag"));

				    	$(".course-comments .comment:nth-of-type(11)").remove();
				    });
				    

				    // Callback handler that will be called on failure
				    request.fail(function (jqXHR, textStatus, errorThrown){
				        // Log the error to the console
				        console.error(
				            "The following error occurred: "+
				            textStatus, errorThrown
				        );
				    });

				    // Callback handler that will be called regardless
				    // if the request failed or succeeded
				    request.always(function () {
				        // Reenable the inputs
				        inputs.prop("disabled", false);
				    });

		    	{% endif %}

			});
		{% endif %}

		$(".course-comments").on("click", ".comment-delete" , function(){
			let decision = confirm('Do you want to delete this comment?');
			let therf = document.getElementsByName('csrfmiddlewaretoken')[0].value

			if(decision){
				commentpass = $(this).parents(".comment");
		 		commentpassid = commentpass.attr("id");

		 		if (request) {
			        request.abort();
			    }

		 		request = $.ajax({
			        url: "{% url 'course' course_filt.code|lower course_filt.number %}",
			        type: "delete",
			        data: commentpassid,
			        headers: {'X-CSRFToken': '{{ csrf_token }}'}
			    });

			    // Callback handler that will be called on success
			    request.done(function (response, textStatus, jqXHR){

			        commentpass.remove();

			        if (coursect > 0)
			        	coursect = coursect-1;

			        if (coursect == 0){
			        	var halaml = 
			        	`<p class="d-inline-flex">
							<i class="material-icons my-auto">comment</i>
							<span class="my-auto mx-3">
								{% if user.is_authenticated %}
									Be the first to comment!
								{% else %}
									There are no comments to display.
								{% endif %}
							</span>
						</p>`;	
						$(".course-comments").html(halaml);
			        }

					let countvalml = coursect + " comment";
					if (coursect != 1){
						countvalml = countvalml+"s";
					}

					$(".comme-count").html(countvalml);	


			    	response = JSON.parse(response);


			    	if (jQuery.isEmptyObject(response) == false){

			    		function delshow(){

			    			retval = "";
							if (response.user == "{{user.username}}"){
								retval = `<i class="material-icons  material-icon-sm comment-delete">delete</i>`
							}
							return retval;
						};

						function lkshow(a){

							var returnval = ``;
							if (response.liked){

								if (a == "status")
									returnval = `liked`;
								else if (a == "icon")
									returnval = `star`;
							}
							else{
								if (a == "icon")
									returnval = `star_border`
							}

							return returnval
						};

						$(".course-comments").html($(".course-comments").html() + `<div class="py-4 px-4 d-flex mb-3 comment" id="comment-`+response.id + `">
											<img class="user-pic-thumb" src="` + hasImage(response, "profile") + `">
											<div class="ml-4 w-100">
												<div class="d-flex w-100 justify-content-between my-2">
													<span class="my-auto">
														<strong>`+ response.user +`</strong> 
													</span>
													<p class="my-auto">
														<small class="d-inline-flex">
															<span class="mr-3 my-auto">
																<i class="material-icons material-icon-sm {% if user.is_authenticated %}comment-like{%endif%} ` + lkshow("status") + `">
																` + lkshow("icon") + `  
																</i> 
																<span class="my-auto ml-1 mr-2 comment-like-count">`+ response.like_ct+ `</span>
																
																` + delshow() + `
															</span>
															`+ new Date(response.date).toLocaleString('en-us' , timeoptions) +`
														</small>
													</p>
												</div>
												<p>`+  replace_url(response.body) +`</p>
											` + hasImage(response, "comment") + `
											</div>
										</div>`)
			    	}
			    	
			    });
			    

			    // Callback handler that will be called on failure
			    request.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error(
			            "The following error occurred: "+
			            textStatus, errorThrown
			        );
			    });

		 	}
		}); 


		$(".course-comments").on("click", ".comment-like" , function(){
			let therf = document.getElementsByName('csrfmiddlewaretoken')[0].value
			
			let clicked = $(this);

			commentpass = $(this).parents(".comment");
	 		commentpassid = commentpass.attr("id");

	 		if (request) {
		        request.abort();
		    }

	 		request = $.ajax({
		        url: "{% url 'comment_like' course_filt.code|lower course_filt.number %}",
		        type: "post",
		        data: commentpassid,
		        headers: {'X-CSRFToken': '{{ csrf_token }}'}
		    });

		    // Callback handler that will be called on success
		    request.done(function (response, textStatus, jqXHR){
		    	let icons = ["star_border", "star"];

		    	response = JSON.parse(response);
		    	console.log(response.state);

		    	clicked.parent().children(".comment-like-count").html(response.count);

		    	if (response.state){
		    		clicked.html(icons[1]);
		    		clicked.addClass("liked");
		    	}
		    	else{
		    		clicked.html(icons[0]);
		    		clicked.removeClass("liked");
		    	}
		    });
		    

		    // Callback handler that will be called on failure
		    request.fail(function (jqXHR, textStatus, errorThrown){
		        // Log the error to the console
		        console.error(
		            "The following error occurred: "+
		            textStatus, errorThrown
		        );
		    });		 	
		}); 


		

		function initCourseSection(){
    		// Clear input image
    		$(".comment-image-upload input").val("");

    		var image_drops = document.querySelectorAll(".import-image-drag");
    		for (i = 0; i < image_drops.length; i++){
    			clearImage(image_drops[i].getAttribute("data-file-target"),image_drops[i])
    		}

    		// Visuals: Liked comments
    		var commentvisual = {{liked_comments}};

			for(i = 0; i < commentvisual.length; i++){
				$("#comment-"+commentvisual[i]).find(".comment-like").html("star");
				$("#comment-"+commentvisual[i]).find(".comment-like").addClass("liked");
			}

			// Image button Popup
			var popper = new Popper($(".import-image-drag"), $(".addphoto-popper"), {
			    placement: 'right',
			    modifiers:{

			    	arrow:{
			    		
			    	}
			    }
			});
    	}



		initCourseSection();

	</script>
{% endblock %}