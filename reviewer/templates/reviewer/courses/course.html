
{% extends 'reviewer/base.html' %}


{% block title %}
	{{ course_filt.name }}
{% endblock %}

{% load static %}
{% block content %}
	<div class="container pt-5">
		<div class="my-5">
			<div class="m-auto d-flex flex-column align-items-start">
				<div class="w-100">
					<div class="mx-3">
						<div class="d-flex justify-content-between flex-column flex-lg-row mb-3 mb-lg-0">
							<div class="mx-auto mx-lg-0 text-center text-lg-left">
								<h1 class="h1 title course-{{course_filt.id}}" ><strong>{{ course_filt.code }} <span class="import-font-primary">{{ course_filt.number }}</span></strong></h1>
								<h4 class=" h4 mt-2">{{ course_filt.title }}</h4>
							</div>
							<div class="mx-auto mx-lg-0  text-center text-lg-right">
								<div>
									<small class="d-flex">
										<i class="material-icons material-icon-sm mx-2">update</i> Last Updated: {{ course_filt.lastupdated|date:"M d, Y, h:i A" }}
									</small>
									{% if course_filt.old_curr == True %}
										<small class="d-inline-flex mt-1">
											<i class="material-icons material-icon-sm mx-2">error_outline</i>
											This is part of an old curriculum.
										</small>
									{% endif %}
								</div>
							</div>
						</div>
						<div class="mt-1 row">
							<div class="d-flex flex-column col-lg-8 ml-lg-0 ml-auto mr-auto">

								<p class="text-center text-lg-left">{{course_filt.description}}</p>
								<small>
									<div class="mb-1">
										<span>Prerequisites:</span>
										<div class="d-inline-flex align-items-start">
											{% if course_filt.prereqs.count > 0 %}
												{% for prereq in course_filt.prereqs.all %}
													{% if forloop.counter != 1 %}<span class="mr-1">,</span>{%endif%}
													<a href="{% url 'course' prereq.code|lower prereq.number %}">
														{{ prereq.name }}
													</a>
												{% endfor %}
											{% else %}
												None
											{% endif %}
										</div>
									</div>
									<div>
										<span>Corequisites:</span>
										<div class="d-inline-flex align-items-start">
											{% if course_filt.coreqs.count > 0 %}
												{% for coreq in course_filt.coreqs.all %}
													{% if forloop.counter != 1 %}<span class="mr-1">,</span>{%endif%}
													<a href="{% url 'course' coreq.code|lower coreq.number %}">
														{{ coreq.name }}
													</a>
												{% endfor %}
											{% else %}
												None
											{% endif %}
										</div>
									</div>
								</small>
							</div>

							{% if  user.is_superuser %}
								<div class="ml-auto mt-lg-auto mt-0 mb-auto mb-lg-0 col-lg-4 d-flex">
									<a class="ml-auto" href="{% url 'admin_course_id' course_filt.code|lower course_filt.number  'edit' %}">
										<button  type="button" class="btn btn-light px-3 d-flex">
											<div class="my-auto d-flex">
												<i class="material-icons">
													edit
												</i>
												<span class="my-auto ml-1 d-none d-md-block">
												Edit Course</span>	
											</div>
										</button>
									</a>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="course-tabs">
			<ul class="nav nav-tabs" id="coursetab" role="tablist">
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'l' %}active{%endif%}" id="lessons-tab" data-toggle="tab" href="#lessons" role="tab" aria-controls="lessons" aria-selected="true">Lessons</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'c' %}active{%endif%}" id="comments-tab" data-toggle="tab" href="#comments" role="tab" aria-controls="profile" aria-selected="false">
			    	Comments
			    	<div class="ml-auto my-auto position-absolute active-visible">
			    		<div class="d-flex position-relative" style="left: 4.7em; bottom:2.5em">
							<i class="material-icons my-auto mr-2 import-font-primary">mode_comment</i> 
							<div class="position-absolute d-flex" style="color: white; width: 1.5em"><small class="comme-count position-relative m-auto font-weight-bold" style="top:0.05em">
								{{ course_comment_count }}
							</small></div>
						</div>
					</div>
			    </a>
			    
			  </li>
			  <li class="nav-item">
			    <a class="nav-link {% if section == 'r' %}active{%endif%}" id="ref-tab" data-toggle="tab" href="#ref" role="tab" aria-controls="ref" aria-selected="false">References</a>
			  </li>
			</ul>
			<div class="tab-content" id="import-tabcontents">
			  <div class="tab-pane fade {% if section == 'l' %} show active{%endif%}" id="lessons" role="tabpanel" aria-labelledby="lessons-tab">
			  	...
			  </div>
			  <div class="tab-pane fade {% if section == 'c' %} show active{%endif%}" id="comments" role="tabpanel" aria-labelledby="comments-tab">
			  		{% include 'reviewer/partials/course/course-comments.html' %}
			  </div>
			  <div class="tab-pane fade {% if section == 'r' %} show active{%endif%}" id="ref" role="tabpanel" aria-labelledby="ref-tab">
			  		{% include 'reviewer/partials/course/course-references.html' %}
			  </div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}

	<script src="{% static 'reviewer/js/import_comments.js' %}"></script>

	<!-- Comments -->
	<script class="d-none">

		var coursect =  {{course_comment_count}};

		var timeoptions = {
	    	year: 'numeric',
	    	month: 'short',
	    	day: 'numeric',
	    	timeZone: "Asia/Manila",
	    	hour12: true,
	    	hour: "2-digit", 
	    	minute: "2-digit"  
    	};


		{% if cpage == 1 %}
			$(".comment-form").submit(function(event){

		    // Prevent default posting of form - put here to work in case of errors
		    event.preventDefault();

		    	{% if user.is_authenticated %}

				    if (importApp.request)
				        importApp.request.abort();
				  
				    var form = $(this);
				    var formData = new FormData(this);
				    var inputs = form.find("input, select, button, textarea");
				    inputs.prop("disabled", true);
				   
				    importApp.request =  $.ajax({
		                type: 'post',
		                url: "{% url 'course' course_filt.code|lower course_filt.number %}",
		                data: formData,
		                cache: false,
		                contentType: false,
		                processData: false
	                });

				    importApp.request.done(function (response, textStatus, jqXHR){

				    	let newcomment = response.comment_html;
						coursect != 0? $(".course-comments").prepend(newcomment) : $(".course-comments").html(newcomment);
						
						newcomment = $(".course-comments [data-comment-id='comment-" + response.commentid + "']");
						newcomment.addClass("the-new-comment");
						newcommentbody = newcomment.find('.comment-body');
						console.log(newcommentbody.html());
						newcommentbody.html( 
							replace_url(replace_vid_url( newcommentbody.html() )) 
						);

						newcomment.fadeIn(2000);
						newcomment.removeClass("the-new-comment");
						renderMathInElement(document.body);
						coursect = coursect+1;
						$(".comme-count").html(coursect);

				    	$(".comment-text-area").val("");
				    	clearImage("comment-image-upload", document.querySelector(".import-image-drag"));

				    	$(".course-comments .comment:nth-of-type(" + ({{page_limit}}+1) +")").remove();
				    });
				    

				    importApp.request.fail(function (jqXHR, textStatus, errorThrown){
				        console.error( "The following error occurred: " + textStatus, errorThrown );
				    });

				    importApp.request.always(function () {
				        inputs.prop("disabled", false);
				    });

		    	{% endif %}

			});
		{% endif %}

		$(".course-comments").on("click", ".comment-delete" , function(){
			let decision = confirm('Do you want to delete this comment?');

			if(decision){
				commentpass = $(this).parents(".comment");
		 		commentpassid = commentpass.attr("id");

		 		if (importApp.request) {
			        importApp.request.abort();
			    }

		 		importApp.request = $.ajax({
			        url: "{% url 'course' course_filt.code|lower course_filt.number %}",
			        type: "delete",
			        data: commentpassid,
			        headers: {'X-CSRFToken': importApp.csrfToken }
			    });

			    // Callback handler that will be called on success
			    importApp.request.done(function (response, textStatus, jqXHR){

			        commentpass.remove();

			        if (coursect > 0)
			        	coursect = coursect-1;

			        if (coursect == 0){
			        	var halaml = 
			        	`<p class="d-inline-flex">
							<i class="material-icons my-auto">comment</i>
							<span class="my-auto mx-3">
								{% if user.is_authenticated %}
									Be the first to comment!
								{% else %}
									There are no comments to display.
								{% endif %}
							</span>
						</p>`;	
						$(".course-comments").html(halaml);
			        }

					
					$(".comme-count").html(coursect);	


			    	if (jQuery.isEmptyObject(response) == false){

			    		function delshow(){

			    			retval = "";
							if (response.user == "{{user.username}}"){
								retval = `<i class="material-icons  material-icon-sm comment-delete" title="Delete comment">delete</i>`
							}
							return retval;
						};

						function lkshow(a){

							var returnval = ``;
							if (response.liked){

								if (a == "status")
									returnval = `liked`;
								else if (a == "icon")
									returnval = `star`;
							}
							else{
								if (a == "icon")
									returnval = `star_border`
							}

							return returnval
						};

						$(".course-comments").html($(".course-comments").html() + 
							`<div class="py-4 px-4 d-flex mb-3 comment" id="comment-`+response.id + `">
								<a href="` + window.location.origin + response.user_url + `">
									<img class="user-pic-thumb" src="` + hasImage(response, "profile") + `">
								</a>
								
								<div class="ml-4 w-100">
									<div class="d-flex w-100 justify-content-between my-2">
										<span class="my-auto">
											<a href="` + window.location.origin + response.user_url +`" class="comment-username">
												<strong>
													` + response.user + `
												</strong>
											</a> 
										</span>
										<div class="my-auto float-right">
											<div class="position-relative py-1 px-2 comment-action d-flex">
												<div class="d-inline-flex ml-auto my-auto">
													<span class="mr-3 my-auto d-flex">
														<i class="material-icons material-icon-sm {% if user.is_authenticated %}comment-like{%endif%} ` + lkshow("status") + `">` + 
																lkshow("icon") + `
														</i> 
														<div class="my-auto ml-1 mr-2 comment-like-count inline-block">
															`+ response.like_ct+ `
														</div>
														` + delshow() +`
													</span>
													<small class="my-auto">`+ new Date(response.date).toLocaleString('en-us' , timeoptions) +`</small>
												</div>
											</div>
										</div>
									</div>
									<div class="comment-body">
										`+  replace_url(replace_vid_url(response.body)) +`
									</div>

									` + hasImage(response, "comment") + `
								
								</div>
							</div>`
						);

						renderMathInElement(document.body)
					}
			   
			    });
			    

			    // Callback handler that will be called on failure
			    importApp.request.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error(
			            "The following error occurred: "+
			            textStatus, errorThrown
			        );
			    });

		 	}
		}); 

		
		function initCourseSection(){
    		importApp.setConfig('like_url',"{% url 'comment_like' '$course_code' 123456789 %}");
    		importApp.setConfig('comments_page_limit', {{page_limit}});
    		importApp.comments.loadLikeIcon({{liked_comments}});
    		initDragBoxData(true)
    	}

    	initCourseSection();

	</script>
{% endblock %}