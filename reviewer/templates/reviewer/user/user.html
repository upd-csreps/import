{% extends 'reviewer/base.html' %}


{% block title %}
	{{user_filt.username}}
{% endblock %}

{% load static %}
{% block content %}
	<div class="container py-5">
		<div class="row pt-5">
			<div class="col-lg-4 d-flex">
				<div class="mr-auto ml-lg-4 ml-auto d-flex flex-column">
					<div class="mx-auto prof-pic" >
						<img class="user-pic" src="
						{% if user_filt.prof_picID %}
							https://drive.google.com/uc?export=view&id={{user_filt.prof_picID}}
						{% else %}
							{% static 'reviewer/images/default_profile.png' %}
						{% endif %}
						">

						{% if user.is_authenticated %}
							{% if user.username == user_filt.username %}
								<div class="d-flex position-absolute prof-pic-edit" style="z-index: 5" title="Edit profile picture"> 
									<i class="material-icons m-auto p-0" style="font-size: 70px">
										edit
									</i>
								</div>
								<div class="d-flex position-absolute prof-pic-edit prof-pic-edit-overlay">
								</div>
							{% endif %}
						{% endif %}

						{% if user_filt.fave_lang %}
							<div class="position-absolute lang-badge lang-badge-offset" style="background-image: url('{{user_filt.fave_lang.image.url}}');">
							</div>
						{% endif %}
					</div>

					{% if user.is_authenticated %}
						{% if user.username == user_filt.username %}
							<form action="{% url 'user' user_filt.username %}" method="post" enctype="multipart/form-data" class="d-none position-absolute" id="user-pic-form">
									{% csrf_token %}    
								    <input type="file" name="image" id="user-pic-upload" accept="image/*"/>
								    <input type="submit" value="Save Changes" name="save" />        
							</form>
						{% endif %}
					{% endif %}
					<h3 class="h3 mx-auto my-3"><strong>{{user_filt.username}}</strong></h3>
					<p class="mx-auto">Experience Points: {{user_filt.exp}}</p>

					<small class="mx-auto">
						<div class="row">
							<div class="col-6">
								<p class="font-weight-bold mb-1">First Name</p>
								<p class="d-inline-flex">
									<span class="my-auto">{{user_filt.first_name}} {{user_filt.suffix}}</span>
								</p>

								{% if user_filt.middle_name != None %}
									<p class="font-weight-bold mb-1">Middle Name</p>
									<p class="d-inline-flex">
										<span class="my-auto">{{user_filt.middle_name}}</span>
									</p>
								{% endif %}

								<p class="font-weight-bold mb-1">Last Name</p>
								<p class="d-inline-flex">
									<span class="my-auto">{{user_filt.last_name}}</span>
								</p>
							</div>
							<div class="col-6">
								{% if user_filt.studentnum != None %}
									<p class="font-weight-bold mb-1">Student Number</p>
									<p>
										{% if user_filt.show_studentnum %} 
											{{user_filt.studentnum}}
										{% else %}
											<span class="text-muted d-inline-flex">
												<i class="material-icons material-icon-sm my-auto mr-2 info-help" title="Only you can see this information.">
													visibility_off
												</i>
												<span class="my-auto">
													{% if user.username == user_filt.username %}
														{{user_filt.studentnum}}
													{% else %}
														Hidden
													{% endif %}
												</span>
											</span>
										{% endif %}
										</p>
								{% endif %}

								<p class="font-weight-bold mb-1">E-mail</p>
								<p>
									{% if user_filt.show_email %} 
										{{user_filt.email}}
									{% else %}
										<span class="text-muted d-inline-flex">
											<i class="material-icons material-icon-sm my-auto mr-2 info-help" title="Only you can see this information.">
												visibility_off
											</i>
											<span class="my-auto">
												{% if user.username == user_filt.username %}
													{{user_filt.email }}
												{% else %}
													Hidden
												{% endif %}
											</span>
										</span>
									{% endif %}
								</p>

								{% if user_filt.course != None or user_filt.course != "" %}
									<p class="font-weight-bold mb-1">Degree Program</p>
									<p>{{user_filt.course}}</p>
								{% endif %}
							</div>
						</div>
					</small>
				</div>
			</div>
			<div class="col-lg-8 course-comments mt-5 mt-lg-0" >

				<ul class="nav nav-tabs d-flex mt-2" id="myTab" role="tablist">
					<h2 class="mb-0 font-weight-bold d-flex">
						<span class="position-relative ml-2" style="bottom: 0.25em">
							Comments
						</span>
					</h2>
				  <li class="nav-item ml-auto">
				    <a class="nav-link active" id="created-tab" data-toggle="tab" href="#created" role="tab" aria-controls="created" aria-selected="true">

				    		Created

				    	<div class="ml-auto my-auto position-absolute active-visible">
				    		<div class="d-flex position-relative" style="left: 3.4em; bottom:2.5em">
								<i class="material-icons my-auto mr-2 import-font-primary">mode_comment</i> 
								<div class="position-absolute d-flex" style="color: white; width: 1.5em"><small class="created-count position-relative m-auto font-weight-bold " style="top:0.05em">
										{{ comments_count  }}
								</small></div>
							</div>
						</div>

				    </a>
				  </li>
				  <li class="nav-item mr-2">
				    <a class="nav-link" id="liked-tab" data-toggle="tab" href="#liked" role="tab" aria-controls="liked" aria-selected="false">Liked

				    <div class="ml-auto my-auto position-absolute active-visible">
			    		<div class="d-flex position-relative" style="left: 2.15em; bottom:2.5em">
							<i class="material-icons my-auto mr-2 import-font-primary">mode_comment</i> 
							<div class="position-absolute  d-flex" style="color: white; width: 1.5em"><small class="liked-count position-relative m-auto font-weight-bold" style="top:0.05em">
									{{ liked_comments_data_count }}
							</small></div>
						</div>
					</div>

				    </a>
				  </li>
				</ul>
				<div class="tab-content" id="myTabContent">
				  <div class="tab-pane fade show active" id="created" role="tabpanel" aria-labelledby="created-tab">
				  	<div class="comments px-3 user-comments">
			  			{% if comments_count == 0 %}

			  				<div class="mt-3 d-inline-flex text-muted">
				  				<i class="material-icons my-auto mr-2">
								comment
								</i>
								<span class="my-auto">{{user_filt.username}} has not made any comments.</span>
							</div>

						{% else %}
							{% for comment in user_comments %}
								{% include 'reviewer/partials/comment.html' %}
							{% endfor %}
						{% endif %}					
					</div>
				  </div>
				  <div class="tab-pane fade" id="liked" role="tabpanel" aria-labelledby="liked-tab">
				  	<div class="comments px-3 liked-comments">
				  		{% if liked_comments_data_count == 0 %}
				  			<div class="mt-3 d-inline-flex text-muted">
				  				<i class="material-icons my-auto mr-2">
									star
								</i>
								<span class="my-auto">{{user_filt.username}} has not liked any comments.</span>
							</div>
						{% else %}
							{% for comment in liked_comments_data %}
								{% include 'reviewer/partials/comment.html' %}
							{% endfor %}
				  		{% endif %}
						
					</div>

				  </div>
				</div>				
			</div>
		</div>

{% endblock %}


{% block modal %}

	<div class="modal fade" id="CropImageModal" tabindex="-1" role="dialog" aria-labelledby="CropImageModalTitle" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title">Crop Image</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			    
				      <div class="modal-body d-flex" style="height: 400px">
				        <div class="croppie m-auto" style="height:300px; width:300px"></div>
				      </div>
				      <div class="modal-footer d-flex justify-content-between">
				      	 <button class="btn btn-light d-inline-flex save-skip-image">
							<i class="material-icons my-auto material-icon-sm mr-2">
							save
							</i>
							<span class="my-auto">Skip Cropping</span>
						</button>
				        <button class="btn btn-primary d-inline-flex save-crop-image">
							<i class="material-icons my-auto material-icon-sm mr-2">
							crop
							</i>
							<span class="my-auto">Crop and Save Image</span>
						</button>
				      </div>

			    </div>
			  </div>
			</div>
	</div>



{% endblock %}

{% block styles %}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.4/croppie.min.css">

{% endblock %}

{% block scripts %}

	<script src="{% static 'reviewer/js/import_comments.js' %}"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.4/croppie.min.js"></script>
	
	<script>

		var croppie_size = 200; 

		var croppie = $('.croppie').croppie({
		    viewport: { width: croppie_size, height: croppie_size,  type: 'circle'},
		    boundary:{width: 300, height:300 }
		});

		$('.prof-pic').on('click', function(){
			$("#user-pic-form input[type=file]").click();
		});

		function readFile(file) {                                                       
		    var reader = new FileReader();
		    reader.onload = readSuccess;                                            
		    function readSuccess(evt) { 

		    	var image = new Image();
		    	var size = 0;
	            image.src = evt.target.result;

	            image.onload = function(){
			  
			        var imagesize = Math.min(this.width, this.height);
					size = croppie_size/imagesize;

				  	$('.cr-slider').attr({'min': size, 'max': size*2.25 });
			    };

		       croppie.croppie('bind', {
				    url: evt.target.result,
				    zoom: size
				});                               
		    };
		    reader.readAsDataURL(file);                                             
		} 

		function CropSubmit(form_name, crop){

			if (importApp.requests.ajax)
		        importApp.request.ajax.abort();

			var CropForm = document.getElementById(form_name);
			var fd = new FormData(CropForm);
			var userURL = "{% url 'user' user_filt.username %}";

			if (crop){

				var image_name = fd.get('image').name
				fd.delete('image');
				
				croppie.croppie('result', {
					type: 'blob',
					size: 'original',
					circle: false
				}).then(function(response){
					fd.append("image", response, image_name);
					CropSubmitSend();
				});

			}
	        else{
	        	CropSubmitSend();
	        }

	        function CropSubmitSend(){

	        	$(".loader-screen").fadeIn();

		        importApp.requests.ajax = $.ajax({
		            url: userURL,
		            type: 'post',
		            data: fd,
		            contentType: false,
		            processData: false,
		        });		

		        importApp..requests.ajax.done(function (response, textStatus, jqXHR){
					console.log(response);

					if (response.error)
						alert(response.error);
					window.location.href = window.location.href;
				});
					    

			    // Callback handler that will be called on failure
			    importApp.requests.ajax.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error("The following error occurred: " + textStatus, errorThrown );
			        $(".loader").addClass("failed");
			    });

			    importApp.requests.ajax.always(function(){
			    	$(".loader").removeClass("failed");
			    	$(".loader-screen").fadeOut();
			    });

	        }
		}


		$('#user-pic-upload').on("change", function(){ 
			readFile(this.files[0])
			$('#CropImageModal').modal('show');
		});

		$(".user-pic-form").on("submit", function(e){
			e.preventDefault();
			$('#CropImageModal').modal('hide');
			CropSubmit('user-pic-form', false);
		});

		$(".save-skip-image").on("click", function(){
			$('#CropImageModal').modal('hide');
			CropSubmit('user-pic-form', false);
			
		});

		$(".save-crop-image").on("click", function(){
			$('#CropImageModal').modal('hide');
			CropSubmit('user-pic-form', true);
		});

		{% if error %}
			alert("{{error}}");
		{% endif %}

		importApp.comments.loadLikeIcon({{liked_comments}});
		importApp.load({ 
			urls: {  like_url : "{% url 'comment_like' '$course_code' 123456789 %}" } 
		});

		$(".course-comments").on("click", ".comment-delete" , function(){

			let decision = confirm('Do you want to delete this comment?');

			if(decision){
				commentpass = $(this).parents(".comment");
	 			commentpassid = commentpass.attr("data-comment-id");

		 		if (importApp.requests.ajax)
			        importApp.requests.ajax.abort();

			    let del_url = "{% url 'course' '$course_code' 123456789 %}";

		 		del_url = del_url.replace('$course_code', commentpass.attr("data-code"));
		 		del_url = del_url.replace('123456789', commentpass.attr("data-number"));

		 		importApp.requests.ajax = $.ajax({
			        url: del_url,
			        type: "delete",
			        data: commentpassid,
			        headers: {'X-CSRFToken': csrfToken }
			    });

			    // Callback handler that will be called on success
			    importApp.requests.ajax.done(function (response, textStatus, jqXHR){
			        commentpass.remove();
			        var commecount = parseInt($(".created-count").html());
			        $(".created-count").html(commecount-1);
			    });


			    // Callback handler that will be called on failure
			    importApp.requests.ajax.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error(
			            "The following error occurred: "+
			            textStatus, errorThrown
			        );
			    });

		 	}
		}); 

	</script>

{% endblock %}