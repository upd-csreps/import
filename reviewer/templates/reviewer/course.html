{% extends 'reviewer/base.html' %}


{% block title %}
	{{ course_filt.name }}
{% endblock %}

{% block content %}
	<div class="container pt-5">
		<div class="my-5">
			<div class="m-auto d-flex flex-column align-items-start">
				<div class="w-100">
					<div class="mx-3">
						<div class="d-flex justify-content-between flex-column flex-lg-row mb-3 mb-lg-0">
							<div class="mx-auto mx-lg-0 text-center text-lg-left">
								<h1 class="h1 title" ><strong>{{ course_filt.code }} <span class="import-font-primary">{{ course_filt.number }}</span></strong></h1>
								<h4 class=" h4 mt-2">{{ course_filt.title }}</h4>
							</div>
							<div class="mx-auto mx-lg-0  text-center text-lg-right">
								<div>
									<small class="d-flex">
										<i class="material-icons material-icon-sm mx-2">update</i> Last Updated: {{ course_filt.lastupdated }}
									</small>
									{% if course_filt.old_curr == True %}
										<small class="d-inline-flex">
											<i class="material-icons material-icon-sm mx-2">error_outline</i>
											This is part of the old curriculum.
										</small>
									{% endif %}
								</div>
							</div>
						</div>
						<div class="mt-1">
							<p>{{course_filt.description}}</p>
							<small>
								<div class="mb-1">
									<span>Prerequisites:</span>
									<div class="d-inline-flex align-items-start">
										{% if course_filt.prereqs.count > 0 %}
											{% for prereq in course_filt.prereqs.all %}
												{% if forloop.counter != 1 %},{%endif%}
												<a href="{% url 'course' prereq.code|lower prereq.number %}">
													{{ prereq.name }}
												</a>
											{% endfor %}
										{% else %}
											None
										{% endif %}
									</div>
								</div>
								<div>
									<span>Corequisites:</span>
									<div class="d-inline-flex align-items-start">
										{% if course_filt.coreqs.count > 0 %}
											{% for coreq in course_filt.coreqs.all %}
												{% if forloop.counter != 1 %},{%endif%}
												<a href="{% url 'course' coreq.code|lower coreq.number %}">
													{{ coreq.name }}
												</a>
											{% endfor %}
										{% else %}
											None
										{% endif %}
									</div>
								</div>
							</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="">
			<ul class="nav nav-tabs" id="myTab" role="tablist">
			  <li class="nav-item">
			    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Lessons</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Comments</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">References</a>
			  </li>
			</ul>
			<div class="tab-content" id="myTabContent">
			  <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">...</div>
			  <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">

			  		<div class="m-3 d-flex pt-4">
			  			<span class="ml-auto my-auto comme-count">{{ course_comment_count }} comment{% if course_comment_count != 1 %}s
			  			{% endif %}</span>
			  		</div>
			  		<div class="row mx-0 pb-4">
			  			<div class="col-lg-4">

			  				{% if user.is_anonymous %}
			  					<p>You must be logged in to comment.</p>
			  				{% endif %}
					  		<form class="form-group comment-form pb-5" enctype="multipart/form-data" method="POST" action="{% url 'course' course_filt.code|lower course_filt.number %}" >
								{% csrf_token %}

								{{ comment_form.body }}

								<div class="my-3 comment-image-upload d-none position-absolute">
									{{ comment_form.image }}
								</div>

								<input class="btn btn-primary mt-3 ml-auto float-right {% if user.is_anonymous %} -disabled {% endif %} course-comment-submit" type="submit" value="Submit" >
							</form>
						</div>
						<div class="col-lg-8 course-comments">
							{% if course_comments.count == 0 %}
								<p class="d-inline-flex">
									<i class="material-icons my-auto">comment</i>
									<span class="my-auto mx-3">
										{% if user.is_authenticated %}
											Be the first to comment!
										{% else %}
											There are no comments to display.
										{% endif %}
									</span>
								</p>
							{% else %}
						  		{% for comment in course_comments %}
									<div class="py-4 px-4 d-flex mb-3 comment" id="comment-{{comment.id}}">
										<img class="user-pic-thumb" src="{{comment.user_attr.prof_pic.url}}">
										<div class="ml-4 w-100">
											<div class="d-flex w-100 justify-content-between my-2">
												<span class="my-auto">
													<strong>{{comment.user_attr.username}}</strong> 
												</span>
												<p class="my-auto">
													<small class="d-inline-flex">
														<span class="mr-3 my-auto">
															{% if user.is_authenticated %}
																<i class="material-icons material-icon-sm mx-2 comment-reply">reply</i>
															{% endif %}
															{% if user == comment.user_attr %}
																<i class="material-icons  material-icon-sm comment-delete">delete</i>
															{% endif %}
														</span>
														{{comment.date_posted}}
													</small>
												</p>
											</div>
											<p>{{comment.body}}</p>
											{% if comment.image %}
												<img class="mt-3 d-block comment-image" src="{{comment.image.url}}">
											{% endif %}
										
										</div>
									</div>
								{% endfor %}
							{% endif %}
						</div>
					</div>
			  </div>
			  <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">...</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}
	<script>
		var request;
		var coursect =  {{course_comment_count}};

		function addCommentDisplay(response, datestring, bodystring){
		
			var newcomment = 
			`<div class="py-4 px-4 d-flex mb-3 comment the-new-comment" id="comment-`+ response.commentid + `" style="display:none;">
				<img class="user-pic-thumb" src="{{ user.prof_pic.url }}">
				<div class="ml-4 w-100">
					<div class="d-flex w-100 justify-content-between my-2">
						<span class="my-auto">
							<strong>{{ user.username }}</strong> 
						</span>
						<p class="my-auto">
							<small class="d-inline-flex">
								<span class="mr-3 my-auto">
									{% if user.is_authenticated %}
										<i class="material-icons material-icon-sm mx-2 comment-reply">reply</i>
									{% endif %}
									<i class="material-icons  material-icon-sm comment-delete">delete</i>
								</span>` +
								datestring
							+ `</small>
						</p>
					</div>
					<p>` + bodystring + `</p>
					
				
				</div>
			</div>`;

			if (coursect != 0){				
				newcomment = newcomment + $(".course-comments").html();
			}
			
			$(".course-comments").html(newcomment);
			$(".the-new-comment").fadeIn(2000);
			$(".the-new-comment").removeClass("the-new-comment");

			coursect = coursect+1;

			let countvalml = coursect + " comment";
			if (coursect != 1){
				countvalml = countvalml+"s";
			}

			$(".comme-count").html(countvalml);			
			
		}

		$(".comment-form").submit(function(event){

	    // Prevent default posting of form - put here to work in case of errors
	    event.preventDefault();

	    	{% if user.is_authenticated %}

			    // Abort any pending request
			    if (request) {
			        request.abort();
			    }
			    // setup some local variables
			    var form = $(this);

			    // Let's select and cache all the fields
			    var inputs = form.find("input, select, button, textarea");

			    // Serialize the data in the form
			    var serializedData = form.serialize();

			    // Let's disable the inputs for the duration of the Ajax request.
			    // Note: we disable elements AFTER the form data has been serialized.
			    // Disabled form elements will not be serialized.
			    inputs.prop("disabled", true);

			    // Fire off the request to url
			    request = $.ajax({
			        url: "{% url 'course' course_filt.code|lower course_filt.number %}",
			        type: "post",
			        data: serializedData
			    });

			    
			     
			    // Callback handler that will be called on success
			    request.done(function (response, textStatus, jqXHR){
			        // Log a message to the console

			        var timeoptions = {
				    	year: 'numeric',
				    	month: 'short',
				    	day: 'numeric',
				    	timeZone: "Asia/Manila",
				    	hour12: true,
				    	hour: "2-digit", 
				    	minute: "2-digit"  
			    	}
			    
			    	response = JSON.parse(response);
			        var today = new Date().toLocaleString('en-us' , timeoptions);
			    	var commtent = $(".comment-text-area").val();
			    	addCommentDisplay(response, today, commtent);
			    	$(".comment-text-area").val("");
			    });
			    

			    // Callback handler that will be called on failure
			    request.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error(
			            "The following error occurred: "+
			            textStatus, errorThrown
			        );
			    });

			    // Callback handler that will be called regardless
			    // if the request failed or succeeded
			    request.always(function () {
			        // Reenable the inputs
			        inputs.prop("disabled", false);
			    });

	    	{% endif %}

		});

		$(".course-comments").on("click", ".comment-delete" , function(){
			let decision = confirm('Do you want to delete this comment?');
			let therf = document.getElementsByName('csrfmiddlewaretoken')[0].value

			if(decision){
				commentpass = $(this).parents(".comment");
		 		commentpassid = commentpass.attr("id");

		 		if (request) {
			        request.abort();
			    }

		 		request = $.ajax({
			        url: "{% url 'course' course_filt.code|lower course_filt.number %}",
			        type: "delete",
			        data: commentpassid,
			        headers: {'X-CSRFToken': '{{ csrf_token }}'}
			    });

			    // Callback handler that will be called on success
			    request.done(function (response, textStatus, jqXHR){
			        commentpass.remove();

			        if (coursect > 0)
			        	coursect = coursect-1;

			        if (coursect == 0){
			        	var halaml = 
			        	`<p class="d-inline-flex">
							<i class="material-icons my-auto">comment</i>
							<span class="my-auto mx-3">
								{% if user.is_authenticated %}
									Be the first to comment!
								{% else %}
									There are no comments to display.
								{% endif %}
							</span>
						</p>`;	
						$(".course-comments").html(halaml);
			        }

					let countvalml = coursect + " comment";
					if (coursect != 1){
						countvalml = countvalml+"s";
					}

					$(".comme-count").html(countvalml);	


					
			    });
			    

			    // Callback handler that will be called on failure
			    request.fail(function (jqXHR, textStatus, errorThrown){
			        // Log the error to the console
			        console.error(
			            "The following error occurred: "+
			            textStatus, errorThrown
			        );
			    });

		 	}
		}); 

	</script>
{% endblock %}